<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Crash Game | SkinCasino</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --accent: #ff9800; --text: #e0e0e0;
            --color-bad: #8f3838; --color-norm: #3e5bc2; --color-good: #54b947; --color-epic: #a93ec2; --color-gold: #c2983e;
        }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; min-height: 100vh; overflow: hidden; }

        header { background: var(--panel); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; height: 50px; }
        .logo { font-size: 20px; font-weight: 800; color: var(--accent); text-decoration: none; }
        .user-panel { display: flex; align-items: center; gap: 15px; background: #252525; padding: 5px 15px; border-radius: 8px; }
        .balance { color: #4caf50; font-weight: bold; }

        /* ОСНОВНАЯ РАЗМЕТКА: ИГРА СЛЕВА, ИГРОКИ СПРАВА */
        .main-layout { display: flex; flex: 1; height: calc(100vh - 50px); }

        /* ЛЕВАЯ ЧАСТЬ (ГРАФИК + КНОПКИ) */
        .game-section { flex: 3; display: flex; flex-direction: column; border-right: 1px solid #333; position: relative; }

        .history-bar { height: 40px; background: #161616; display: flex; align-items: center; gap: 5px; padding: 0 10px; overflow: hidden; mask-image: linear-gradient(to right, black 90%, transparent 100%); }
        .badge { padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 12px; color: white; background: #333; white-space: nowrap; }
        .badge-bad { background: var(--color-bad); color: #ffcccc; }
        .badge-norm { background: var(--color-norm); color: #cce0ff; }
        .badge-good { background: var(--color-good); color: #ccffcc; }
        .badge-epic { background: var(--color-epic); color: #f2ccff; }
        .badge-gold { background: var(--color-gold); color: #fff5cc; }

        .chart-container { flex: 1; position: relative; background: #1a1a1a; overflow: hidden; }
        canvas { width: 100%; height: 100%; }
        .center-info { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; width: 100%; pointer-events: none; }
        .multiplier { font-size: 90px; font-weight: 900; color: white; text-shadow: 0 0 30px rgba(0,0,0,0.8); font-variant-numeric: tabular-nums; }
        .status-text { font-size: 20px; color: #aaa; margin-top: 5px; font-weight: bold; text-transform: uppercase; }

        /* ПАНЕЛЬ СТАВОК (ДВЕ ШТУКИ) */
        .controls-wrapper { height: 220px; background: var(--panel); display: flex; gap: 10px; padding: 15px; box-sizing: border-box; border-top: 1px solid #333; }
        .bet-column { flex: 1; background: #252525; border-radius: 10px; padding: 15px; display: flex; flex-direction: column; gap: 10px; position: relative; }

        .bet-row { display: flex; gap: 10px; align-items: center; }
        .input-group { flex: 1; position: relative; }
        .input-label { font-size: 10px; color: #888; position: absolute; top: 5px; left: 10px; }
        input { background: #1a1a1a; border: 1px solid #444; color: white; padding: 20px 10px 5px 10px; border-radius: 6px; font-size: 16px; outline: none; width: 100%; box-sizing: border-box; font-weight: bold; }

        .quick-actions { display: flex; gap: 5px; justify-content: space-between; }
        .qa-btn { flex: 1; background: #333; border: none; color: #aaa; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; transition: 0.2s; }
        .qa-btn:hover { background: #444; color: white; }

        .action-btn { width: 100%; height: 50px; border: none; border-radius: 6px; font-weight: 800; font-size: 16px; cursor: pointer; text-transform: uppercase; transition: 0.1s; margin-top: auto; }
        .btn-bet { background: var(--accent); color: black; }
        .btn-bet:hover { background: #ffaa33; }
        .btn-cashout { background: var(--color-good); color: white; }
        .btn-waiting { background: #444; color: #888; cursor: not-allowed; }

        /* ПРАВАЯ ЧАСТЬ (ТАБЛИЦА ИГРОКОВ) */
        .sidebar { flex: 1; min-width: 250px; max-width: 350px; background: #181818; border-left: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; font-weight: bold; color: #aaa; border-bottom: 1px solid #333; display: flex; justify-content: space-between; font-size: 13px; }
        .bets-list { flex: 1; overflow-y: auto; }

        .bet-item { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #222; font-size: 13px; align-items: center; transition: background 0.2s; }
        .bet-item.winner { background: rgba(84, 185, 71, 0.1); border-left: 3px solid var(--color-good); }
        .user-info { display: flex; align-items: center; gap: 8px; color: white; font-weight: 600; }
        .bet-val { color: #ccc; }
        .profit { color: var(--color-good); font-weight: bold; }
        .mult-badge { background: #333; padding: 2px 6px; border-radius: 4px; color: #fff; font-size: 11px; }
    </style>
</head>
<body>

<header>
    <a href="/" class="logo">SKINCASINO</a>
    <div class="user-panel">
        <div style="text-align: right;">
            <div th:text="${user.username}" id="username" style="font-size: 14px;">User</div>
            <div class="balance"><i class="fas fa-coins"></i> <span id="userBalance" th:text="${user.balance}">0</span></div>
        </div>
        <a href="/logout" style="color: #ff5252; margin-left: 10px;"><i class="fas fa-power-off"></i></a>
    </div>
</header>

<div class="main-layout">
    <div class="game-section">
        <div class="history-bar" id="historyBar"></div>

        <div class="chart-container">
            <canvas id="crashCanvas"></canvas>
            <div class="center-info">
                <div class="multiplier" id="multiDisplay">1.00x</div>
                <div class="status-text" id="statusDisplay">CONNECTING...</div>
            </div>
        </div>

        <div class="controls-wrapper">
            <div class="bet-column" id="slot1">
                <div class="quick-actions">
                    <button class="qa-btn" onclick="modBet(1, 'min')">MIN</button>
                    <button class="qa-btn" onclick="modBet(1, '/2')">1/2</button>
                    <button class="qa-btn" onclick="modBet(1, 'x2')">x2</button>
                    <button class="qa-btn" onclick="modBet(1, 'max')">MAX</button>
                </div>
                <div class="input-group">
                    <span class="input-label">СТАВКА (Слот 1)</span>
                    <input type="number" id="betInput1" value="100">
                </div>
                <button class="action-btn btn-bet" id="btn1" onclick="doAction(1)">ПОСТАВИТЬ</button>
            </div>

            <div class="bet-column" id="slot2">
                <div class="quick-actions">
                    <button class="qa-btn" onclick="modBet(2, 'min')">MIN</button>
                    <button class="qa-btn" onclick="modBet(2, '/2')">1/2</button>
                    <button class="qa-btn" onclick="modBet(2, 'x2')">x2</button>
                    <button class="qa-btn" onclick="modBet(2, 'max')">MAX</button>
                </div>
                <div class="input-group">
                    <span class="input-label">СТАВКА (Слот 2)</span>
                    <input type="number" id="betInput2" value="100">
                </div>
                <button class="action-btn btn-bet" id="btn2" onclick="doAction(2)">ПОСТАВИТЬ</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <span>ИГРОКОВ: <span id="playersCount">0</span></span>
            <span>СТАВОК: <span id="totalBetsVal">0</span></span>
        </div>
        <div class="bets-list" id="betsList">
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('crashCanvas');
    const ctx = canvas.getContext('2d');
    const multiDisplay = document.getElementById('multiDisplay');
    const statusDisplay = document.getElementById('statusDisplay');
    const balanceSpan = document.getElementById('userBalance');
    const historyBar = document.getElementById('historyBar');
    const betsList = document.getElementById('betsList');
    const myUsername = document.getElementById('username').innerText;

    // Состояние
    let gameState = "UNKNOWN";
    let currentBalance = 0;

    // Состояние слотов: 0=нет ставки, 1=ставка принята (ждем старт), 2=в игре, 3=вывел, 4=краш
    let slotState = { 1: 0, 2: 0 };

    // Плавность
    let flightStartTime = 0;
    let waitingEndTime = 0;
    let isFlying = false;

    function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.onresize = resize;
    resize();

    setInterval(fetchStatus, 200);
    requestAnimationFrame(animateLoop);

    function modBet(slot, action) {
        let input = document.getElementById('betInput' + slot);
        let val = parseInt(input.value) || 0;
        if (action === 'min') val = 10;
        if (action === '/2') val = Math.floor(val / 2);
        if (action === 'x2') val = val * 2;
        if (action === 'max') val = currentBalance;
        if (val < 10) val = 10;
        input.value = val;
    }

    async function fetchStatus() {
        try {
            const res = await fetch('/api/crash/status');
            const data = await res.json();

            currentBalance = data.balance;
            balanceSpan.innerText = data.balance;
            updateHistory(data.history);
            updateBetsTable(data.bets);

            // ОПРЕДЕЛЯЕМ СОСТОЯНИЕ МОИХ СТАВОК ИЗ СЕРВЕРА
            // Ищем мои ставки в списке
            let myBets = data.bets.filter(b => b.username === myUsername);

            // Сбрасываем состояния если новый раунд WAITING
            if (data.status === "WAITING" && gameState !== "WAITING") {
                slotState[1] = 0;
                slotState[2] = 0;
            }

            // Обновляем состояние кнопок на основе данных сервера
            // Если я есть в списке ставок на сервере -> значит ставка принята
            [1, 2].forEach(slot => {
                let bet = myBets.find(b => b.slot === slot);
                if (bet) {
                    if (bet.profit != null) slotState[slot] = 3; // Вывел
                    else if (data.status === "RUNNING") slotState[slot] = 2; // Летим
                    else if (data.status === "CRASHED") slotState[slot] = 4; // Краш
                    else slotState[slot] = 1; // Ждем старта
                } else if (data.status !== "WAITING" && slotState[slot] !== 0) {
                    // Если игры нет, а у нас состояние не 0 - сбрасываем (новый раунд)
                    slotState[slot] = 0;
                }
            });

            // СИНХРОНИЗАЦИЯ ИГРЫ
            if (data.status === "WAITING") {
                if (gameState !== "WAITING") {
                    gameState = "WAITING";
                    isFlying = false;
                }
                let remaining = 10 - data.elapsed;
                waitingEndTime = Date.now() + (remaining * 1000);
                statusDisplay.innerText = "PLACING BETS...";

            } else if (data.status === "RUNNING") {
                gameState = "RUNNING";
                if (!isFlying) {
                    isFlying = true;
                    flightStartTime = Date.now() - (data.elapsed * 1000);
                }

            } else if (data.status === "CRASHED") {
                isFlying = false;
                gameState = "CRASHED";
                multiDisplay.innerText = data.multiplier.toFixed(2) + "x";
                multiDisplay.style.color = "#ff4b2b";
                statusDisplay.innerText = "CRASHED";
                drawGraph(10, data.multiplier); // Застывший график
            }

            updateButtons(data.multiplier);

        } catch (e) { console.error(e); }
    }

    function animateLoop() {
        if (gameState === "WAITING") {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let timeLeft = (waitingEndTime - Date.now()) / 1000;
            if (timeLeft < 0) timeLeft = 0;
            multiDisplay.innerText = "START IN " + timeLeft.toFixed(1) + "s";
            multiDisplay.style.color = "white";
        }

        if (gameState === "RUNNING" && isFlying) {
            let elapsedSeconds = (Date.now() - flightStartTime) / 1000;
            let currentMultiplier = Math.pow(1.07, elapsedSeconds);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            multiDisplay.innerText = currentMultiplier.toFixed(2) + "x";
            multiDisplay.style.color = "white";
            statusDisplay.innerText = "FLYING...";

            drawGraph(elapsedSeconds, currentMultiplier);
            updateButtons(currentMultiplier); // Обновляем текст выигрыша на кнопке
        }
        requestAnimationFrame(animateLoop);
    }

    function updateButtons(currentMult) {
        [1, 2].forEach(slot => {
            let btn = document.getElementById('btn' + slot);
            let state = slotState[slot];

            if (gameState === "WAITING") {
                if (state === 0) { // Можно ставить
                    btn.className = "action-btn btn-bet";
                    btn.innerText = "ПОСТАВИТЬ";
                    btn.disabled = false;
                } else { // Ставка уже принята
                    btn.className = "action-btn btn-waiting";
                    btn.innerText = "ГОТОВ...";
                    btn.disabled = true;
                }
            } else if (gameState === "RUNNING") {
                if (state === 2) { // В игре, можно забрать
                    let betVal = document.getElementById('betInput' + slot).value;
                    let win = (betVal * currentMult).toFixed(0);
                    btn.className = "action-btn btn-cashout";
                    btn.innerText = "ЗАБРАТЬ " + win;
                    btn.disabled = false;
                } else if (state === 3) { // Вывел
                    btn.className = "action-btn btn-waiting";
                    btn.innerText = "УСПЕХ";
                    btn.disabled = true;
                } else { // Не ставил или ждет
                    btn.className = "action-btn btn-waiting";
                    btn.innerText = "ИГРА ИДЕТ";
                    btn.disabled = true;
                }
            } else { // CRASHED
                btn.className = "action-btn btn-waiting";
                btn.innerText = "КРАШ";
                btn.disabled = true;
            }
        });
    }

    function doAction(slot) {
        if (gameState === "WAITING") {
            // СТАВКА
            let amount = document.getElementById('betInput' + slot).value;
            fetch(`/api/crash/bet?amount=${amount}&slot=${slot}`, { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    if (d.success) slotState[slot] = 1; // Локально помечаем, что поставили
                    else alert(d.error);
                });
        } else if (gameState === "RUNNING") {
            // ВЫВОД
            fetch(`/api/crash/cashout?slot=${slot}`, { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    if (d.success) slotState[slot] = 3; // Локально помечаем успех
                });
        }
    }

    function updateBetsTable(bets) {
        if (!bets) return;
        document.getElementById('playersCount').innerText = bets.length;
        document.getElementById('totalBetsVal').innerText = bets.reduce((a, b) => a + b.amount, 0);

        // Сортируем: сначала те кто вывел (по профиту), потом кто в игре (по сумме)
        bets.sort((a, b) => {
            if (a.profit && !b.profit) return -1;
            if (!a.profit && b.profit) return 1;
            return b.amount - a.amount;
        });

        let html = "";
        bets.forEach(b => {
            let winClass = b.profit ? "winner" : "";
            let profitHtml = b.profit ?
                `<span class="mult-badge">x${b.cashoutMultiplier.toFixed(2)}</span> <span class="profit">+${b.profit}</span>` :
                `<span class="bet-val">${b.amount}</span>`;

            // Аватарка (заглушка с первой буквой)
            let avatar = `<div style="width:24px;height:24px;background:#333;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;">${b.username.charAt(0)}</div>`;

            html += `
                <div class="bet-item ${winClass}">
                    <div class="user-info">${avatar} ${b.username}</div>
                    <div>${profitHtml}</div>
                </div>
            `;
        });
        betsList.innerHTML = html;
    }

    // --- Рисовалки (те же, что и были) ---
    function drawGraph(time, mult) {
        ctx.beginPath();
        ctx.lineWidth = 5;
        ctx.strokeStyle = '#ff9800';
        ctx.lineCap = 'round';
        let w = canvas.width, h = canvas.height;
        ctx.moveTo(0, h);
        for(let t=0; t<=time; t+=0.1) {
            let x = (t/10)*w;
            let m = Math.pow(1.07, t);
            let y = h - ((m-1)/(mult-1+0.5))*(h*0.8);
            ctx.lineTo(x, y);
        }
        ctx.stroke();
    }

    let lastHistoryId = 0;
    function updateHistory(history) {
        if (!history || (history.length > 0 && history[0].id === lastHistoryId)) return;
        if (history.length > 0) lastHistoryId = history[0].id;

        historyBar.innerHTML = "";
        history.forEach(g => {
            let d = document.createElement('div');
            d.className = 'badge';
            d.innerText = g.crashPoint.toFixed(2) + 'x';
            if (g.crashPoint < 1.1) d.classList.add('badge-bad');
            else if (g.crashPoint < 2) d.classList.add('badge-norm');
            else if (g.crashPoint < 4) d.classList.add('badge-good');
            else if (g.crashPoint < 10) d.classList.add('badge-epic');
            else d.classList.add('badge-gold');
            historyBar.appendChild(d);
        });
    }
</script>

</body>
</html>